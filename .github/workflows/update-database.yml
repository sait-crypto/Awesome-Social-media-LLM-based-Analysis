name: Process Paper Submission PR

on:
  pull_request:
    paths:
      - 'submit_template.json'
      - 'submit_template.xlsx'
      - 'figures/**'
    branches: [ main ]
    types: [opened, synchronize, labeled, reopened]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # æ§åˆ¶å¤„ç†æ¨¡å¼çš„ç¯å¢ƒå˜é‡
  # è®¾ç½®ä¸º "True" æ—¶ï¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰æäº¤çš„è®ºæ–‡ PR
  # è®¾ç½®ä¸º "False" æ—¶ï¼šéœ€è¦æ‰‹åŠ¨æ‰¹å‡†ï¼ˆæ·»åŠ  approved æ ‡ç­¾ï¼‰
  AUTO_PROCESS_MODE: ${{ vars.AUTO_PROCESS_SUBMISSIONS || 'False' }}

jobs:
  process-submission:
    runs-on: ubuntu-latest
    
    # æ ¹æ®å¤„ç†æ¨¡å¼å†³å®šè¿è¡Œæ¡ä»¶
    if: |
      # 1. æ€»æ˜¯å…è®¸æ‰‹åŠ¨è§¦å‘
      github.event_name == 'workflow_dispatch' ||
      
      # 2. è‡ªåŠ¨æ¨¡å¼ï¼šå¤„ç†å¸¦æœ‰ paper-submission æ ‡ç­¾æˆ–åˆ†æ”¯åçš„ PR
      (env.AUTO_PROCESS_MODE == 'True' && github.event_name == 'pull_request' && (
        contains(github.event.pull_request.labels.*.name, 'paper-submission') ||
        contains(github.event.pull_request.head.ref, 'paper-submission')
      )) ||
      
      # 3. æ‰‹åŠ¨æ¨¡å¼ï¼šåªå¤„ç†å¸¦æœ‰æ‰¹å‡†æ ‡ç­¾çš„ PR
      (env.AUTO_PROCESS_MODE == 'False' && github.event_name == 'pull_request' && 
        contains(github.event.pull_request.labels.*.name, 'paper-submission-approved'))
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Display processing mode
      run: |
        echo "========================================="
        if [ "$AUTO_PROCESS_MODE" = "True" ]; then
          echo "ğŸ¤– è‡ªåŠ¨å¤„ç†æ¨¡å¼å·²å¯ç”¨"
          echo "å°†è‡ªåŠ¨å¤„ç†æ‰€æœ‰å¸¦æœ‰ 'paper-submission' æ ‡ç­¾çš„ PR"
        else
          echo "ğŸ‘¨â€ğŸ’¼ æ‰‹åŠ¨æ‰¹å‡†æ¨¡å¼å·²å¯ç”¨"
          echo "åªå¤„ç†å¸¦æœ‰ 'paper-submission-approved' æ ‡ç­¾çš„ PR"
          echo ""
          echo "å®¡æ ¸åï¼Œè¯·æ·»åŠ  'paper-submission-approved' æ ‡ç­¾æ¥è§¦å‘å¤„ç†"
        fi
        echo "========================================="
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl requests python-dateutil
        
        # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†å¿…éœ€çš„åŒ…
        python -c "import pandas, openpyxl, requests; print('âœ… ä¾èµ–å®‰è£…æˆåŠŸ')"
    
    - name: Check for update files
      id: check-files
      run: |
        echo "ğŸ“ æ£€æŸ¥æ›´æ–°æ–‡ä»¶..."
        JSON_EXISTS=False
        EXCEL_EXISTS=False
        
        if [ -f "submit_template.json" ] && [ -s "submit_template.json" ]; then
          echo "âœ… æ‰¾åˆ°éç©ºæ–‡ä»¶: submit_template.json"
          JSON_EXISTS=True
        else
          echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º: submit_template.json"
        fi
        
        if [ -f "submit_template.xlsx" ] && [ -s "submit_template.xlsx" ]; then
          echo "âœ… æ‰¾åˆ°éç©ºæ–‡ä»¶: submit_template.xlsx"
          EXCEL_EXISTS=True
        else
          echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º: submit_template.xlsx"
        fi
        
        echo "json_exists=$JSON_EXISTS" >> $GITHUB_OUTPUT
        echo "excel_exists=$EXCEL_EXISTS" >> $GITHUB_OUTPUT
        
        if [ "$JSON_EXISTS" = "False" ] && [ "$EXCEL_EXISTS" = "False" ]; then
          echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„æ›´æ–°æ–‡ä»¶"
          exit 1
        else
          echo "âœ… æ‰¾åˆ°å¯å¤„ç†çš„æ›´æ–°æ–‡ä»¶"
        fi
    
    - name: Set up environment variables
      run: |
        # è®¾ç½®Excelå¯†ç ï¼ˆä»GitHub Secretè¯»å–ï¼‰
        if [ -n "${{ secrets.EXCEL_KEY }}" ]; then
          echo "EXCEL_KEY=${{ secrets.EXCEL_KEY }}" >> $GITHUB_ENV
        else
          echo "EXCEL_KEY=" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®DeepSeek APIå¯†é’¥ï¼ˆä»GitHub Secretè¯»å–ï¼‰
        if [ -n "${{ secrets.DEEPSEEK_API }}" ]; then
          echo "DEEPSEEK_API=${{ secrets.DEEPSEEK_API }}" >> $GITHUB_ENV
        else
          echo "DEEPSEEK_API=" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®PRä¿¡æ¯
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "GITHUB_PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "GITHUB_PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "GITHUB_PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "GITHUB_PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
        else
          echo "GITHUB_PR_NUMBER=MANUAL" >> $GITHUB_ENV
          echo "GITHUB_PR_AUTHOR=workflow_dispatch" >> $GITHUB_ENV
          echo "GITHUB_PR_TITLE=Manual Trigger" >> $GITHUB_ENV
          echo "GITHUB_PR_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®å¤„ç†æ¨¡å¼ä¿¡æ¯
        echo "PROCESSING_MODE=${{ env.AUTO_PROCESS_MODE }}" >> $GITHUB_ENV
        
    - name: Validate update templates
      id: validate-templates
      run: |
        echo "ğŸ” éªŒè¯æ›´æ–°æ¨¡æ¿æ–‡ä»¶ï¼ˆJSON / Excel / figuresï¼‰..."
        cd scripts
        python validate_update_files.py

    - name: Process validated PR and update main
      id: process-pr
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ”§ åˆå¹¶æ–°å›¾ç‰‡å¹¶è¿è¡Œæ›´æ–°å¤„ç†å™¨..."
        cd scripts
        python process_pr_update.py

    - name: Check update result
      id: update-result
      run: |
        if [ -f "scripts/update_result.json" ]; then
          RESULT=$(cat scripts/update_result.json)
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "âœ… æ›´æ–°å¤„ç†å™¨æ‰§è¡Œå®Œæˆ"
        else
          echo "result={\"success\": False, \"message\": \"æœªç”Ÿæˆç»“æœæ–‡ä»¶\"}" >> $GITHUB_OUTPUT
          echo "âš ï¸  æ›´æ–°å¤„ç†å™¨æœªç”Ÿæˆç»“æœæ–‡ä»¶"
        fi
    
    - name: Generate README
      if: steps.process-pr.outcome == 'success'
      run: |
        echo "ğŸ“„ ç”Ÿæˆ README..."
        cd scripts
        python convert.py
        
        # æ£€æŸ¥READMEæ˜¯å¦æ›´æ–°
        if git diff --name-only HEAD | grep -q "README.md"; then
          echo "âœ… README å·²æ›´æ–°"
          echo "readme_updated=True" >> $GITHUB_ENV
        else
          echo "â„¹ï¸  README æœªæ›´æ”¹"
          echo "readme_updated=False" >> $GITHUB_ENV
        fi
    
    - name: Commit changes
      if: steps.process-pr.outcome == 'success'
      run: |
        echo "ğŸ’¾ æäº¤æ›´æ”¹..."
        
        # é…ç½®Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet; then
          echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          echo "changes_committed=False" >> $GITHUB_ENV
        else
          # æ·»åŠ æ›´æ”¹
          git add .
          
          # æäº¤æ›´æ”¹
          COMMIT_MESSAGE="Automated update from PR #$GITHUB_PR_NUMBER"
          
          if [ "$PROCESSING_MODE" = "False" ]; then
            COMMIT_MESSAGE="$COMMIT_MESSAGE (manually approved)"
          fi
          
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆPRåˆ†æ”¯ï¼‰
          git push
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          echo "changes_committed=True" >> $GITHUB_ENV
        fi
    
    - name: Create summary comment
      run: |
        echo "ğŸ’¬ åˆ›å»ºPRè¯„è®ºæ‘˜è¦..."
        
        # åˆ›å»ºå¤„ç†ç»“æœæ‘˜è¦
        SUMMARY="## ğŸ“Š è®ºæ–‡æäº¤å¤„ç†ç»“æœ\n\n"
        
        # æ˜¾ç¤ºå¤„ç†æ¨¡å¼
        if [ "$PROCESSING_MODE" = "True" ]; then
          SUMMARY+="**å¤„ç†æ¨¡å¼:** ğŸ¤– è‡ªåŠ¨å¤„ç†\n\n"
        else
          SUMMARY+="**å¤„ç†æ¨¡å¼:** ğŸ‘¨â€ğŸ’¼ æ‰‹åŠ¨æ‰¹å‡†\n\n"
        fi
        
        if [ "${{ steps.process-pr.outcome }}" = "success" ]; then
          SUMMARY+="âœ… **æˆåŠŸå¤„ç†æäº¤**\n\n"
          
          # æ·»åŠ æˆåŠŸè¯¦æƒ…
          SUMMARY+="- æ›´æ–°æ–‡ä»¶å·²å¤„ç†\n"
          
          if [ "$readme_updated" = "True" ]; then
            SUMMARY+="- README å·²æ›´æ–°\n"
          else
            SUMMARY+="- README æ— éœ€æ›´æ–°\n"
          fi
          
          if [ "$changes_committed" = "True" ]; then
            SUMMARY+="- æ›´æ”¹å·²æäº¤åˆ° PR åˆ†æ”¯\n"
          fi
          
          SUMMARY+="\næ„Ÿè°¢æ‚¨çš„æäº¤ï¼è®ºæ–‡æ•°æ®åº“å·²æ›´æ–°ã€‚"
          
        else
          SUMMARY+="âŒ **å¤„ç†å¤±è´¥**\n\n"
          SUMMARY+="æäº¤æ— æ³•è‡ªåŠ¨å¤„ç†ã€‚\n\n"
          SUMMARY+="**å¯èƒ½çš„åŸå› :**\n"
          SUMMARY+="- æ–‡ä»¶æ ¼å¼æ— æ•ˆ\n"
          SUMMARY+="- ç¼ºå°‘å¿…å¡«å­—æ®µ\n"
          SUMMARY+="- æ•°æ®åº“æ›´æ–°é”™è¯¯\n\n"
          SUMMARY+="è¯·æ£€æŸ¥æ‚¨çš„æäº¤å¹¶é‡è¯•ï¼Œæˆ–è”ç³»ç»´æŠ¤äººå‘˜ã€‚"
        fi
        
        # æ·»åŠ å¤„ç†ä¿¡æ¯
        SUMMARY+="\n\n---\n"
        SUMMARY+="**å¤„ç†ä¿¡æ¯:**\n"
        SUMMARY+="- PR: #$GITHUB_PR_NUMBER by @$GITHUB_PR_AUTHOR\n"
        SUMMARY+="- æ ‡é¢˜: $GITHUB_PR_TITLE\n"
        SUMMARY+="- è¿è¡ŒID: ${{ github.run_id }}\n"
        SUMMARY+="- æ—¶é—´æˆ³: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # è¾“å‡ºæ‘˜è¦åˆ°æ–‡ä»¶ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
        echo "$SUMMARY" > pr_summary.md
        
        # åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºæ‘˜è¦
        echo "$SUMMARY"
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('pr_summary.md', 'utf8');
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¥è‡ªæœ¬Actionçš„è¯„è®º
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('è®ºæ–‡æäº¤å¤„ç†ç»“æœ')
          );
          
          if (botComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: summary
            });
            console.log('âœ… æ›´æ–°äº†ç°æœ‰è¯„è®º');
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
            console.log('âœ… åˆ›å»ºäº†æ–°è¯„è®º');
          }
    
    - name: Clean up update files
      if: steps.update-process.outcome == 'success'
      run: |
        echo "ğŸ§¹ æ¸…ç†æ›´æ–°æ–‡ä»¶..."
        
        # æ¸…ç©ºæ›´æ–°æ–‡ä»¶
        echo '{"papers": []}' > submit_template.json
        
        # åˆ›å»ºç©ºçš„Excelæ–‡ä»¶
        python -c "
        import pandas as pd
        df = pd.DataFrame()
        df.to_excel('submit_template.xlsx', index=False)
        print('âœ… å·²æ¸…ç©ºæ›´æ–°æ–‡ä»¶')
        "
        
        # æäº¤æ¸…ç†
        if [ "$changes_committed" = "True" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add submit_template.json submit_template.xlsx
          git commit -m "Clear update files after processing"
          git push
          echo "âœ… æ¸…ç†æäº¤å·²æ¨é€"
        fi
    
    - name: Manage labels
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // ç®¡ç†æ ‡ç­¾
          const labels = ['paper-submission'];
          
          if ('${{ steps.process-pr.outcome }}' === 'success') {
            labels.push('processed-successfully');
            
            // åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œå¤„ç†å®Œæˆåç§»é™¤æ‰¹å‡†æ ‡ç­¾
            if ('${{ env.AUTO_PROCESS_MODE }}' === 'False') {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'paper-submission-approved'
                });
                console.log('âœ… å·²ç§»é™¤æ‰¹å‡†æ ‡ç­¾');
              } catch (e) {
                console.log('â„¹ï¸  æ‰¹å‡†æ ‡ç­¾ä¸å­˜åœ¨æˆ–å·²ç§»é™¤');
              }
            }
          } else {
            labels.push('needs-review');
            
            // åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œä¹Ÿç§»é™¤æ‰¹å‡†æ ‡ç­¾
            if ('${{ env.AUTO_PROCESS_MODE }}' === 'False') {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'paper-submission-approved'
                });
              } catch (e) {
                // å¿½ç•¥é”™è¯¯
              }
            }
          }
          
          // æ·»åŠ æ–°æ ‡ç­¾
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: labels
          });
          
          console.log('âœ… å·²æ·»åŠ æ ‡ç­¾: ' + labels.join(', '));
    
    - name: Send notification (optional)
      if: always() && github.event_name == 'pull_request'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "è®ºæ–‡æäº¤ PR #${{ github.event.pull_request.number }} - ${{ job.status }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
        body: |
          è®ºæ–‡æäº¤ PR #${{ github.event.pull_request.number }} å¤„ç†å®Œæˆã€‚
          
          çŠ¶æ€: ${{ job.status }}
          æ¨¡å¼: ${{ env.AUTO_PROCESS_MODE == 'True' ? 'è‡ªåŠ¨å¤„ç†' : 'æ‰‹åŠ¨æ‰¹å‡†' }}
          PRæ ‡é¢˜: ${{ github.event.pull_request.title }}
          ä½œè€…: @${{ github.event.pull_request.user.login }}
          
          æŸ¥çœ‹PR: ${{ github.event.pull_request.html_url }}
          æŸ¥çœ‹è¿è¡Œ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          
          $(cat pr_summary.md)